<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>跳跳板大冒险</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // 主色调：靛蓝色
                        secondary: '#10B981', // 辅助色：绿色
                        accent: '#F59E0B', // 强调色：琥珀色
                        dark: '#1E293B', // 深色
                        light: '#F8FAFC' // 浅色
                    },
                    fontFamily: {
                        game: ['"Press Start 2P"', 'cursive', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .touch-button {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
    </style>
    
    <!-- 引入游戏字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-dark to-primary min-h-screen text-light overflow-x-hidden select-none">
    <!-- 错误提示容器 -->
    <div id="errorContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden">
        <p id="errorMessage"></p>
    </div>
    
    <!-- 游戏容器 -->
    <div class="container mx-auto px-2 py-4 flex flex-col items-center justify-center min-h-screen">
        <!-- 游戏标题 -->
        <h1 class="text-[clamp(1.5rem,5vw,2.5rem)] font-game text-center mb-4 text-accent text-shadow animate-pulse-slow">
            跳跳板大冒险
        </h1>
        
        <!-- 游戏信息面板 -->
        <div class="w-full max-w-3xl flex justify-between items-center mb-3 px-2">
            <div class="bg-dark/70 backdrop-blur-sm rounded-lg px-3 py-2 flex items-center gap-2">
                <i class="fa fa-star text-accent"></i>
                <span class="font-game text-[clamp(0.8rem,2vw,1rem)]">分数: <span id="score" class="text-secondary">0</span></span>
            </div>
            <div class="bg-dark/70 backdrop-blur-sm rounded-lg px-3 py-2 flex items-center gap-2">
                <i class="fa fa-trophy text-accent"></i>
                <span class="font-game text-[clamp(0.8rem,2vw,1rem)]">最高分: <span id="highScore" class="text-secondary">0</span></span>
            </div>
        </div>
        
        <!-- 游戏画布容器 -->
        <div class="relative w-full max-w-3xl h-[70vh] bg-dark/50 backdrop-blur-sm rounded-xl overflow-hidden shadow-2xl border-4 border-primary/30">
            <!-- 游戏画布 -->
            <canvas id="gameCanvas" class="w-full h-full"></canvas>
            
            <!-- 移动端虚拟按键 - 仅在移动设备上显示 -->
            <div id="mobileControls" class="fixed bottom-24 right-4 md:hidden z-5">
                <button id="jumpButton" class="touch-button w-16 h-16 bg-accent/80 hover:bg-accent text-dark rounded-full shadow-lg flex items-center justify-center text-2xl active:scale-95 transition-transform">
                    <i class="fa fa-arrow-up"></i>
                </button>
            </div>
            
            <!-- 开始游戏界面 -->
            <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/80 backdrop-blur-md z-10">
                <h2 class="text-[clamp(1.2rem,4vw,2rem)] font-game text-center mb-6 text-accent text-shadow">准备好了吗?</h2>
                <p class="text-center mb-8 px-6 text-[clamp(0.9rem,2vw,1.1rem)] max-w-md">点击或按空格键跳跃，从一个方块跳到另一个方块上，不要掉下去!</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="startButton" class="touch-button bg-accent hover:bg-accent/80 text-dark font-bold py-3 px-6 rounded-lg text-[clamp(0.9rem,2vw,1.1rem)] transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg flex items-center gap-2">
                        <i class="fa fa-play"></i> 开始游戏
                    </button>
                    <button id="howToPlayButton" class="touch-button bg-primary/80 hover:bg-primary text-light font-bold py-3 px-6 rounded-lg text-[clamp(0.9rem,2vw,1.1rem)] transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg flex items-center gap-2">
                        <i class="fa fa-question"></i> 游戏说明
                    </button>
                </div>
            </div>
            
            <!-- 游戏说明界面 -->
            <div id="instructionsScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/90 backdrop-blur-md z-10 hidden">
                <h2 class="text-[clamp(1.2rem,4vw,2rem)] font-game text-center mb-6 text-accent text-shadow">游戏说明</h2>
                <div class="bg-dark/70 rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-3 text-secondary">电脑端操作</h3>
                    <ul class="space-y-2 mb-6">
                        <li class="flex items-center gap-2"><i class="fa fa-keyboard-o text-accent"></i> <span>按空格键跳跃</span></li>
                        <li class="flex items-center gap-2"><i class="fa fa-mouse-pointer text-accent"></i> <span>点击鼠标跳跃</span></li>
                    </ul>
                    
                    <h3 class="text-xl font-bold mb-3 text-secondary">移动端操作</h3>
                    <ul class="space-y-2 mb-6">
                        <li class="flex items-center gap-2"><i class="fa fa-hand-pointer-o text-accent"></i> <span>点击屏幕跳跃</span></li>
                        <li class="flex items-center gap-2"><i class="fa fa-mobile text-accent text-2xl"></i> <span>使用右下角虚拟按钮跳跃</span></li>
                    </ul>
                    
                    <h3 class="text-xl font-bold mb-3 text-secondary">游戏目标</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-accent mt-1"></i>
                            <span>跳到不同的方块上，保持不掉落</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-accent mt-1"></i>
                            <span>绿色方块得1分，粉色特殊方块得5分</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-accent mt-1"></i>
                            <span>游戏会随分数增加而加快速度</span>
                        </li>
                    </ul>
                </div>
                <button id="backButton" class="touch-button mt-8 bg-accent hover:bg-accent/80 text-dark font-bold py-3 px-6 rounded-lg text-[clamp(0.9rem,2vw,1.1rem)] transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg">
                    返回
                </button>
            </div>
            
            <!-- 游戏结束界面 -->
            <div id="gameOverScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-dark/80 backdrop-blur-md z-10 hidden">
                <h2 class="text-[clamp(1.2rem,4vw,2rem)] font-game text-center mb-4 text-red-500 text-shadow">游戏结束!</h2>
                <p class="text-[clamp(1rem,3vw,1.3rem)] mb-2">你的分数: <span id="finalScore" class="text-secondary font-bold">0</span></p>
                <p class="text-[clamp(1rem,3vw,1.3rem)] mb-6">最高分: <span id="gameOverHighScore" class="text-secondary font-bold">0</span></p>
                <button id="restartButton" class="touch-button bg-accent hover:bg-accent/80 text-dark font-bold py-3 px-8 rounded-lg text-[clamp(0.9rem,2vw,1.1rem)] transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg flex items-center gap-2">
                    <i class="fa fa-refresh"></i> 再来一次
                </button>
            </div>
        </div>
        
        <!-- 游戏控制提示 - 仅在桌面设备显示 -->
        <div class="hidden md:flex w-full max-w-3xl mt-4 grid grid-cols-2 gap-3">
            <div class="bg-dark/70 backdrop-blur-sm rounded-lg p-3">
                <h3 class="text-lg font-bold mb-1 text-accent">电脑控制</h3>
                <div class="flex items-center gap-3">
                    <div class="bg-dark/50 w-10 h-10 rounded flex items-center justify-center border border-primary/50">
                        <span class="font-game">空格</span>
                    </div>
                    <span>跳跃</span>
                </div>
                <div class="flex items-center gap-3 mt-1">
                    <div class="bg-dark/50 w-10 h-10 rounded-full flex items-center justify-center border border-primary/50">
                        <i class="fa fa-mouse-pointer"></i>
                    </div>
                    <span>点击跳跃</span>
                </div>
            </div>
            <div class="bg-dark/70 backdrop-blur-sm rounded-lg p-3">
                <h3 class="text-lg font-bold mb-1 text-accent">游戏提示</h3>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-4 bg-[#10B981] rounded-sm"></div>
                    <span>普通方块 (+1分)</span>
                </div>
                <div class="flex items-center gap-3 mt-1">
                    <div class="w-8 h-4 bg-[#EC4899] rounded-sm"></div>
                    <span>特殊方块 (+5分)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 错误处理函数
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            
            // 3秒后自动隐藏错误消息
            setTimeout(() => {
                errorContainer.classList.add('hidden');
            }, 3000);
        }
        
        // 游戏主逻辑
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // 检测设备类型
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                // 获取DOM元素
                const canvas = document.getElementById('gameCanvas');
                if (!canvas) {
                    throw new Error('未找到游戏画布元素');
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error('无法获取画布上下文，浏览器可能不支持Canvas');
                }
                
                const startScreen = document.getElementById('startScreen');
                const instructionsScreen = document.getElementById('instructionsScreen');
                const gameOverScreen = document.getElementById('gameOverScreen');
                const startButton = document.getElementById('startButton');
                const howToPlayButton = document.getElementById('howToPlayButton');
                const backButton = document.getElementById('backButton');
                const restartButton = document.getElementById('restartButton');
                const jumpButton = document.getElementById('jumpButton');
                const scoreElement = document.getElementById('score');
                const highScoreElement = document.getElementById('highScore');
                const finalScoreElement = document.getElementById('finalScore');
                const gameOverHighScoreElement = document.getElementById('gameOverHighScore');
                const mobileControls = document.getElementById('mobileControls');
                
                // 验证所有必要元素是否存在
                const requiredElements = [
                    startScreen, instructionsScreen, gameOverScreen,
                    startButton, howToPlayButton, backButton, restartButton,
                    scoreElement, highScoreElement, finalScoreElement, gameOverHighScoreElement
                ];
                
                requiredElements.forEach((el, index) => {
                    if (!el) {
                        throw new Error(`缺少必要的游戏元素 #${index}`);
                    }
                });
                
                // 根据设备类型显示/隐藏移动控制按钮
                if (!isMobile && mobileControls) {
                    mobileControls.classList.add('hidden');
                }
                
                // 设置画布尺寸
                function resizeCanvas() {
                    try {
                        const container = canvas.parentElement;
                        if (!container) return;
                        
                        // 确保画布保持正确的比例，防止拉伸变形
                        const containerRect = container.getBoundingClientRect();
                        canvas.width = containerRect.width;
                        canvas.height = containerRect.height;
                        
                        // 调整游戏元素大小以适应不同屏幕
                        adjustGameElements();
                        
                        // 如果游戏正在运行，重新绘制
                        if (gameState.isRunning) {
                            draw();
                        }
                    } catch (error) {
                        console.error('画布尺寸调整错误:', error);
                        showError('游戏界面调整失败，请刷新页面');
                    }
                }
                
                // 根据屏幕尺寸调整游戏元素大小
                function adjustGameElements() {
                    if (!gameState) return;
                    
                    // 玩家大小根据屏幕宽度调整
                    const playerSize = Math.max(30, Math.min(60, canvas.width * 0.08));
                    gameState.player.width = playerSize;
                    gameState.player.height = playerSize;
                    
                    // 平台大小根据屏幕宽度调整
                    const platformWidth = Math.max(80, Math.min(150, canvas.width * 0.2));
                    const platformHeight = Math.max(15, Math.min(30, canvas.height * 0.03));
                    
                    if (gameState.platforms && gameState.platforms.length > 0) {
                        gameState.platforms.forEach(platform => {
                            if (platform.type === 'special') {
                                platform.width = platformWidth * 0.8;
                            } else {
                                platform.width = platformWidth;
                            }
                            platform.height = platformHeight;
                        });
                    }
                    
                    // 调整跳跃力度和重力以适应屏幕大小
                    gameState.jumpStrength = -Math.max(10, Math.min(15, canvas.height * 0.025));
                    gameState.gravity = Math.max(0.4, Math.min(0.7, canvas.height * 0.001));
                }
                
                // 初始化时调整画布大小
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                // 游戏状态
                const gameState = {
                    isRunning: false,
                    score: 0,
                    highScore: 0,
                    speed: 3,
                    platforms: [],
                    player: {
                        x: 0,
                        y: 0,
                        width: 40,
                        height: 40,
                        velocityY: 0,
                        jumping: false,
                        color: '#F59E0B' // 琥珀色
                    },
                    gravity: 0.5,
                    jumpStrength: -12,
                    lastTime: 0,
                    spawnTimer: 0,
                    spawnRate: 1000, // 平台生成间隔(毫秒)
                    particleEffects: []
                };
                
                // 加载最高分
                try {
                    const savedHighScore = localStorage.getItem('jumpGameHighScore');
                    gameState.highScore = savedHighScore ? parseInt(savedHighScore, 10) : 0;
                    if (isNaN(gameState.highScore)) {
                        gameState.highScore = 0;
                    }
                } catch (error) {
                    console.error('加载最高分失败:', error);
                    gameState.highScore = 0;
                    showError('无法加载最高分记录');
                }
                
                // 更新最高分显示
                highScoreElement.textContent = gameState.highScore;
                
                // 初始化玩家位置
                function initPlayer() {
                    gameState.player.x = canvas.width / 4;
                    gameState.player.y = canvas.height / 2;
                    gameState.player.velocityY = 0;
                    gameState.player.jumping = false;
                }
                
                // 初始化平台
                function initPlatforms() {
                    gameState.platforms = [];
                    
                    // 平台大小根据屏幕宽度调整
                    const platformWidth = Math.max(80, Math.min(150, canvas.width * 0.2));
                    const platformHeight = Math.max(15, Math.min(30, canvas.height * 0.03));
                    
                    // 添加初始平台
                    const initialPlatformCount = isMobile ? 4 : 5; // 移动设备减少初始平台数量
                    const platformGap = canvas.height / (isMobile ? 5 : 6);
                    
                    for (let i = 0; i < initialPlatformCount; i++) {
                        const platform = {
                            x: Math.random() * (canvas.width - platformWidth) + platformWidth/4,
                            y: canvas.height - i * platformGap,
                            width: platformWidth,
                            height: platformHeight,
                            color: '#10B981', // 绿色
                            type: 'normal', // normal, special
                            speedX: 0
                        };
                        
                        // 随机生成一些特殊平台
                        if (i > 0 && Math.random() < 0.15) {
                            platform.type = 'special';
                            platform.color = '#EC4899'; // 粉色
                            platform.width = platformWidth * 0.8;
                        }
                        
                        // 移动平台在移动设备上出现概率降低
                        const mobileSpeedFactor = isMobile ? 0.1 : 0.2;
                        if (i > 0 && Math.random() < mobileSpeedFactor) {
                            // 移动速度根据屏幕宽度调整
                            const speedFactor = canvas.width * 0.001;
                            platform.speedX = (Math.random() - 0.5) * 2 * speedFactor;
                        }
                        
                        gameState.platforms.push(platform);
                    }
                }
                
                // 生成新平台
                function spawnPlatform(timestamp) {
                    if (!gameState.lastTime) gameState.lastTime = timestamp;
                    const elapsed = timestamp - gameState.lastTime;
                    
                    gameState.spawnTimer += elapsed;
                    
                    // 平台大小根据屏幕宽度调整
                    const platformWidth = Math.max(80, Math.min(150, canvas.width * 0.2));
                    const platformHeight = Math.max(15, Math.min(30, canvas.height * 0.03));
                    
                    if (gameState.spawnTimer > gameState.spawnRate) {
                        // 基于最高分调整生成速率，使游戏越来越难
                        const adjustedSpawnRate = Math.max(500, 1000 - (gameState.highScore / 10) * 100);
                        gameState.spawnRate = adjustedSpawnRate;
                        
                        // 计算最后一个平台的位置，确保新平台在合理范围内
                        const lastPlatform = gameState.platforms[gameState.platforms.length - 1];
                        const minY = lastPlatform.y - canvas.height / 4;
                        const maxY = lastPlatform.y - canvas.height / 8;
                        
                        const platform = {
                            x: Math.random() * (canvas.width - platformWidth) + platformWidth/4,
                            y: Math.random() * (maxY - minY) + minY,
                            width: platformWidth,
                            height: platformHeight,
                            color: '#10B981', // 绿色
                            type: 'normal',
                            speedX: 0
                        };
                        
                        // 随机生成特殊平台
                        if (Math.random() < 0.15) {
                            platform.type = 'special';
                            platform.color = '#EC4899'; // 粉色
                            platform.width = platformWidth * 0.8;
                        }
                        
                        // 移动平台在移动设备上出现概率降低
                        const mobileSpeedFactor = isMobile ? 0.1 : 0.2;
                        if (Math.random() < mobileSpeedFactor) {
                            // 移动速度根据屏幕宽度调整
                            const speedFactor = canvas.width * 0.001;
                            platform.speedX = (Math.random() - 0.5) * 2 * speedFactor;
                        }
                        
                        gameState.platforms.push(platform);
                        gameState.spawnTimer = 0;
                    }
                    
                    gameState.lastTime = timestamp;
                }
                
                // 更新平台位置
                function updatePlatforms() {
                    // 移除超出屏幕的平台
                    gameState.platforms = gameState.platforms.filter(platform => 
                        platform.y < canvas.height + 50
                    );
                    
                    // 更新平台位置
                    gameState.platforms.forEach(platform => {
                        platform.y += gameState.speed;
                        
                        // 移动平台的水平移动
                        if (platform.speedX !== 0) {
                            platform.x += platform.speedX;
                            
                            // 边界检查
                            if (platform.x < 0) {
                                platform.x = 0;
                                platform.speedX *= -1;
                            } else if (platform.x + platform.width > canvas.width) {
                                platform.x = canvas.width - platform.width;
                                platform.speedX *= -1;
                            }
                        }
                    });
                    
                    // 基于分数调整游戏速度，移动设备初始速度稍慢
                    const baseSpeed = isMobile ? 2.5 : 3;
                    gameState.speed = baseSpeed + Math.min(5, gameState.score / 50);
                }
                
                // 检查玩家与平台的碰撞
                function checkCollision() {
                    if (gameState.player.velocityY <= 0) return false; // 只有下落时才检测碰撞
                    
                    for (const platform of gameState.platforms) {
                        // 简单的AABB碰撞检测
                        if (
                            gameState.player.x + gameState.player.width > platform.x &&
                            gameState.player.x < platform.x + platform.width &&
                            gameState.player.y + gameState.player.height >= platform.y &&
                            gameState.player.y + gameState.player.height <= platform.y + gameState.player.velocityY + 10
                        ) {
                            // 玩家落在平台上
                            gameState.player.y = platform.y - gameState.player.height;
                            gameState.player.velocityY = 0;
                            gameState.player.jumping = false;
                            
                            // 普通平台加1分，特殊平台加5分
                            if (platform.type === 'special') {
                                gameState.score += 5;
                                createParticles(platform.x + platform.width/2, platform.y, 10, platform.color);
                            } else {
                                gameState.score += 1;
                            }
                            
                            scoreElement.textContent = gameState.score;
                            
                            return true;
                        }
                    }
                    
                    return false;
                }
                
                // 创建粒子效果
                function createParticles(x, y, count, color) {
                    for (let i = 0; i < count; i++) {
                        const particle = {
                            x: x,
                            y: y,
                            size: Math.random() * 5 + 2,
                            speedX: (Math.random() - 0.5) * 6,
                            speedY: (Math.random() - 0.5) * 6,
                            color: color,
                            life: Math.random() * 30 + 20
                        };
                        
                        gameState.particleEffects.push(particle);
                    }
                }
                
                // 更新粒子效果
                function updateParticles() {
                    gameState.particleEffects = gameState.particleEffects.filter(particle => {
                        particle.x += particle.speedX;
                        particle.y += particle.speedY;
                        particle.life--;
                        return particle.life > 0;
                    });
                }
                
                // 更新玩家状态
                function updatePlayer() {
                    // 应用重力
                    gameState.player.velocityY += gameState.gravity;
                    gameState.player.y += gameState.player.velocityY;
                    
                    // 边界检查
                    if (gameState.player.x < 0) {
                        gameState.player.x = 0;
                    } else if (gameState.player.x + gameState.player.width > canvas.width) {
                        gameState.player.x = canvas.width - gameState.player.width;
                    }
                    
                    // 检查是否掉落
                    if (gameState.player.y > canvas.height) {
                        endGame();
                    }
                    
                    // 检查是否碰撞到平台
                    checkCollision();
                }
                
                // 绘制玩家
                function drawPlayer() {
                    ctx.fillStyle = gameState.player.color;
                    
                    // 绘制玩家（圆形）
                    ctx.beginPath();
                    ctx.arc(
                        gameState.player.x + gameState.player.width / 2,
                        gameState.player.y + gameState.player.height / 2,
                        gameState.player.width / 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // 绘制眼睛，根据跳跃状态改变方向
                    const eyeY = gameState.player.jumping ? 
                        gameState.player.y + gameState.player.height * 0.4 : 
                        gameState.player.y + gameState.player.height * 0.35;
                    
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(
                        gameState.player.x + gameState.player.width * 0.65,
                        eyeY,
                        gameState.player.width * 0.15,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(
                        gameState.player.x + gameState.player.width * 0.7,
                        eyeY,
                        gameState.player.width * 0.08,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
                
                // 绘制平台
                function drawPlatforms() {
                    gameState.platforms.forEach(platform => {
                        ctx.fillStyle = platform.color;
                        
                        // 绘制平台主体
                        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                        
                        // 为特殊平台添加发光效果
                        if (platform.type === 'special') {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                            ctx.fillRect(platform.x + 5, platform.y + 5, platform.width - 10, platform.height - 10);
                        }
                        
                        // 为移动平台添加方向指示器
                        if (platform.speedX !== 0) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            const arrowSize = platform.height / 2;
                            const arrowX = platform.speedX > 0 ? 
                                platform.x + platform.width - arrowSize - 5 : 
                                platform.x + 5;
                            
                            ctx.beginPath();
                            ctx.moveTo(arrowX, platform.y + platform.height / 2);
                            ctx.lineTo(arrowX + (platform.speedX > 0 ? arrowSize : -arrowSize), platform.y + platform.height / 2 - arrowSize / 2);
                            ctx.lineTo(arrowX + (platform.speedX > 0 ? arrowSize : -arrowSize), platform.y + platform.height / 2 + arrowSize / 2);
                            ctx.closePath();
                            ctx.fill();
                        }
                    });
                }
                
                // 绘制粒子效果
                function drawParticles() {
                    gameState.particleEffects.forEach(particle => {
                        ctx.fillStyle = particle.color;
                        ctx.globalAlpha = particle.life / 50; // 随着生命值减少而淡出
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1; // 重置透明度
                    });
                }
                
                // 绘制游戏背景
                function drawBackground() {
                    // 渐变背景
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, '#1E293B');
                    gradient.addColorStop(1, '#3B82F6');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // 绘制星星背景
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    const starCount = Math.floor(canvas.width * canvas.height / 10000); // 根据屏幕大小调整星星数量
                    for (let i = 0; i < starCount; i++) {
                        const size = Math.random() * 2 + 1;
                        ctx.beginPath();
                        ctx.arc(
                            Math.random() * canvas.width,
                            Math.random() * canvas.height,
                            size,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                    }
                }
                
                // 绘制游戏
                function draw() {
                    // 清空画布
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // 绘制背景
                    drawBackground();
                    
                    // 绘制平台
                    drawPlatforms();
                    
                    // 绘制玩家
                    drawPlayer();
                    
                    // 绘制粒子效果
                    drawParticles();
                }
                
                // 游戏主循环
                function gameLoop(timestamp) {
                    if (!gameState.isRunning) return;
                    
                    try {
                        // 生成新平台
                        spawnPlatform(timestamp);
                        
                        // 更新游戏状态
                        updatePlayer();
                        updatePlatforms();
                        updateParticles();
                        
                        // 绘制游戏
                        draw();
                        
                        // 继续循环
                        requestAnimationFrame(gameLoop);
                    } catch (error) {
                        console.error('游戏循环错误:', error);
                        showError('游戏运行出错，请重试');
                        endGame();
                    }
                }
                
                // 玩家跳跃
                function jump() {
                    if (!gameState.player.jumping && gameState.isRunning) {
                        gameState.player.velocityY = gameState.jumpStrength;
                        gameState.player.jumping = true;
                        
                        // 添加跳跃粒子效果
                        createParticles(
                            gameState.player.x + gameState.player.width / 2,
                            gameState.player.y + gameState.player.height,
                            5,
                            'rgba(255, 255, 255, 0.8)'
                        );
                    }
                }
                
                // 开始游戏
                function startGame() {
                    try {
                        // 重置游戏状态
                        gameState.isRunning = true;
                        gameState.score = 0;
                        gameState.speed = isMobile ? 2.5 : 3; // 移动设备初始速度稍慢
                        gameState.spawnRate = 1000;
                        gameState.particleEffects = [];
                        
                        // 更新分数显示
                        scoreElement.textContent = '0';
                        
                        // 确保画布已正确设置尺寸
                        if (canvas.width === 0 || canvas.height === 0) {
                            resizeCanvas();
                        }
                        
                        // 初始化玩家和平台
                        initPlayer();
                        initPlatforms();
                        
                        // 隐藏开始界面和说明界面
                        startScreen.classList.add('hidden');
                        instructionsScreen.classList.add('hidden');
                        gameOverScreen.classList.add('hidden');
                        
                        // 开始游戏循环
                        requestAnimationFrame(gameLoop);
                    } catch (error) {
                        console.error('游戏启动错误:', error);
                        showError('游戏启动失败，请刷新页面重试');
                        gameState.isRunning = false;
                    }
                }
                
                // 结束游戏
                function endGame() {
                    gameState.isRunning = false;
                    
                    try {
                        // 更新最高分
                        if (gameState.score > gameState.highScore) {
                            gameState.highScore = gameState.score;
                            localStorage.setItem('jumpGameHighScore', gameState.highScore.toString());
                            highScoreElement.textContent = gameState.highScore;
                        }
                        
                        // 更新游戏结束界面
                        finalScoreElement.textContent = gameState.score;
                        gameOverHighScoreElement.textContent = gameState.highScore;
                        
                        // 显示游戏结束界面
                        gameOverScreen.classList.remove('hidden');
                    } catch (error) {
                        console.error('游戏结束处理错误:', error);
                        showError('游戏结束处理出错');
                    }
                }
                
                // 事件监听 - 使用安全的事件绑定
                if (startButton) startButton.addEventListener('click', startGame);
                if (howToPlayButton) howToPlayButton.addEventListener('click', () => {
                    startScreen.classList.add('hidden');
                    instructionsScreen.classList.remove('hidden');
                });
                if (backButton) backButton.addEventListener('click', () => {
                    instructionsScreen.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                });
                if (restartButton) restartButton.addEventListener('click', () => {
                    gameOverScreen.classList.add('hidden');
                    startGame();
                });
                
                // 移动端跳跃按钮
                if (jumpButton) jumpButton.addEventListener('click', jump);
                
                // 点击屏幕跳跃（主要用于移动设备）
                canvas.addEventListener('click', (e) => {
                    // 防止在移动设备上同时响应按钮和画布点击
                    if (!isMobile || (e.target === canvas && isMobile)) {
                        jump();
                    }
                });
                
                // 空格键跳跃（主要用于桌面设备）
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && gameState.isRunning) {
                        e.preventDefault(); // 防止页面滚动
                        jump();
                    }
                });
                
                // 触摸屏幕跳跃（移动设备）
                canvas.addEventListener('touchstart', (e) => {
                    // 防止在移动设备上同时响应按钮和画布触摸
                    if (e.target === canvas && isMobile) {
                        e.preventDefault(); // 防止默认行为
                        jump();
                    }
                }, { passive: false });
                
                // 页面加载完成后显示准备就绪状态
                console.log('游戏准备就绪');
                
            } catch (error) {
                console.error('游戏初始化错误:', error);
                showError('游戏加载失败: ' + error.message);
            }
        });
    </script>
</body>
</html>