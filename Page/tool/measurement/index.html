<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>轻量测量工具</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <style>
        /* 基础样式 - 极简设计确保加载速度 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* 顶部导航 */
        header {
            background-color: #2563eb;
            color: white;
            padding: 10px 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 16px;
            font-weight: bold;
        }
        
        .header-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
        }
        
        /* 模式切换 */
        .mode-bar {
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            border-bottom: 1px solid #ddd;
            z-index: 90;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .mode-btn.active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        
        /* 主内容区 */
        main {
            padding-top: 80px;
            max-width: 1000px;
            margin: 0 auto;
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* 测量区域 */
        #measurementArea {
            width: 100%;
            height: 60vh;
            background-color: white;
            border: 1px solid #ddd;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        /* 网格背景 */
        .grid-bg {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(#eee 1px, transparent 1px), 
                             linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* 刻度尺样式 */
        .ruler {
            background-color: white;
            position: absolute;
            z-index: 10;
            pointer-events: none;
        }
        
        #topRuler {
            height: 30px;
            top: 0;
            left: 30px;
            right: 0;
            border-bottom: 1px solid #ddd;
        }
        
        #leftRuler {
            width: 30px;
            top: 30px;
            left: 0;
            bottom: 0;
            border-right: 1px solid #ddd;
        }
        
        .ruler-mark {
            position: absolute;
            background-color: #333;
        }
        
        .ruler-label {
            position: absolute;
            font-size: 10px;
            pointer-events: none;
            background-color: white;
            padding: 0 2px;
        }
        
        /* 测量元素 */
        .measure-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #dc2626;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
        }
        
        .measure-line {
            position: absolute;
            height: 2px;
            background-color: #dc2626;
            transform-origin: 0 0;
            z-index: 15;
        }
        
        .measure-label {
            position: absolute;
            background-color: white;
            border: 1px solid #dc2626;
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 3px;
            z-index: 25;
        }
        
        /* 量角器样式 */
        #protractor {
            position: absolute;
            inset: 0;
            display: none;
        }
        
        .protractor-circle {
            position: absolute;
            border: 1px solid #2563eb;
            border-radius: 50%;
        }
        
        .angle-line {
            position: absolute;
            height: 1px;
            background-color: #64748b;
            transform-origin: center;
        }
        
        .angle-label {
            position: absolute;
            font-size: 10px;
            transform: translate(-50%, -50%);
        }
        
        .center-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #2563eb;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
        }
        
        /* 控制面板 */
        .control-panel {
            background-color: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        
        .result-display {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .result-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 22px;
            font-weight: bold;
            color: #2563eb;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .control-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-secondary {
            background-color: #f1f5f9;
            color: #333;
        }
        
        .hint-text {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        /* 设置面板 */
        #settingsPanel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            z-index: 200;
            padding: 20px;
            transition: right 0.3s;
            overflow-y: auto;
        }
        
        #settingsPanel.open {
            right: 0;
        }
        
        .settings-title {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-label {
            font-size: 13px;
            margin-bottom: 5px;
            display: block;
        }
        
        .setting-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .setting-select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .setting-slider {
            width: 100%;
        }
        
        .close-settings {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        
        .save-settings {
            width: 100%;
            padding: 8px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <header>
        <div class="header-title">
            <i class="fa fa-ruler"></i> 轻量测量工具
        </div>
        <button id="settingsBtn" class="header-btn">
            <i class="fa fa-cog"></i>
        </button>
    </header>
    
    <!-- 模式切换栏 -->
    <div class="mode-bar">
        <button id="rulerMode" class="mode-btn active">
            <i class="fa fa-arrows-h"></i> 刻度尺
        </button>
        <button id="protractorMode" class="mode-btn">
            <i class="fa fa-circle-o"></i> 量角器
        </button>
    </div>
    
    <!-- 主内容区 -->
    <main>
        <!-- 测量区域 -->
        <div id="measurementArea">
            <!-- 网格背景 -->
            <div class="grid-bg"></div>
            
            <!-- 顶部刻度尺 -->
            <div id="topRuler" class="ruler">
                <div id="topRulerMarks"></div>
            </div>
            
            <!-- 左侧刻度尺 -->
            <div id="leftRuler" class="ruler">
                <div id="leftRulerMarks"></div>
            </div>
            
            <!-- 量角器 -->
            <div id="protractor">
                <div id="protractorCircle" class="protractor-circle"></div>
                <div id="angleLines"></div>
                <div id="centerDot" class="center-dot"></div>
            </div>
            
            <!-- 测量元素容器 -->
            <div id="measureElements"></div>
        </div>
        
        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="result-display">
                <div class="result-label">当前测量结果</div>
                <div id="measurementResult" class="result-value">0 厘米</div>
            </div>
            
            <div class="btn-group">
                <button id="resetBtn" class="control-btn btn-secondary">
                    <i class="fa fa-refresh"></i> 重置
                </button>
                <button id="fullscreenBtn" class="control-btn btn-primary">
                    <i class="fa fa-expand"></i> 全屏
                </button>
            </div>
            
            <div id="modeHint" class="hint-text">
                刻度尺模式：点击测量区域添加两点，测量直线距离
            </div>
        </div>
    </main>
    
    <!-- 设置面板 -->
    <div id="settingsPanel">
        <button id="closeSettings" class="close-settings">
            <i class="fa fa-times"></i>
        </button>
        <h3 class="settings-title">设置</h3>
        
        <div class="settings-section">
            <h4 class="section-title">刻度尺设置</h4>
            
            <div class="setting-item">
                <div class="setting-label">显示刻度尺</div>
                <div class="setting-checkbox">
                    <input type="checkbox" id="showTopRuler" checked>
                    <label for="showTopRuler">顶部刻度尺</label>
                </div>
                <div class="setting-checkbox">
                    <input type="checkbox" id="showLeftRuler" checked>
                    <label for="showLeftRuler">左侧刻度尺</label>
                </div>
            </div>
            
            <div class="setting-item">
                <label for="rulerPrecision" class="setting-label">刻度精度</label>
                <select id="rulerPrecision" class="setting-select">
                    <option value="1">1毫米</option>
                    <option value="2">2毫米</option>
                    <option value="5">5毫米</option>
                </select>
            </div>
        </div>
        
        <div class="settings-section">
            <h4 class="section-title">量角器设置</h4>
            
            <div class="setting-item">
                <label for="protractorSize" class="setting-label">量角器大小</label>
                <input type="range" id="protractorSize" min="50" max="100" value="80" class="setting-slider">
            </div>
            
            <div class="setting-checkbox">
                <input type="checkbox" id="showAngleLabels" checked>
                <label for="showAngleLabels">显示角度标签</label>
            </div>
        </div>
        
        <button id="saveSettings" class="save-settings">保存设置</button>
    </div>

    <script>
        // 轻量级实现，专注于性能和稳定性
        document.addEventListener('DOMContentLoaded', function() {
            // 基础配置 - 简化计算确保性能
            const PX_PER_MM = 0.2645833333; // 1px = 0.2646mm (96DPI)
            let currentMode = 'ruler'; // 'ruler' 或 'protractor'
            let measurementPoints = [];
            
            // DOM元素引用 - 减少查询次数
            const elements = {
                measurementArea: document.getElementById('measurementArea'),
                measureElements: document.getElementById('measureElements'),
                measurementResult: document.getElementById('measurementResult'),
                modeHint: document.getElementById('modeHint'),
                rulerMode: document.getElementById('rulerMode'),
                protractorMode: document.getElementById('protractorMode'),
                protractor: document.getElementById('protractor'),
                protractorCircle: document.getElementById('protractorCircle'),
                angleLines: document.getElementById('angleLines'),
                centerDot: document.getElementById('centerDot'),
                resetBtn: document.getElementById('resetBtn'),
                fullscreenBtn: document.getElementById('fullscreenBtn'),
                settingsBtn: document.getElementById('settingsBtn'),
                settingsPanel: document.getElementById('settingsPanel'),
                closeSettings: document.getElementById('closeSettings'),
                saveSettings: document.getElementById('saveSettings'),
                topRuler: document.getElementById('topRuler'),
                leftRuler: document.getElementById('leftRuler'),
                topRulerMarks: document.getElementById('topRulerMarks'),
                leftRulerMarks: document.getElementById('leftRulerMarks'),
                showTopRuler: document.getElementById('showTopRuler'),
                showLeftRuler: document.getElementById('showLeftRuler'),
                rulerPrecision: document.getElementById('rulerPrecision'),
                protractorSize: document.getElementById('protractorSize'),
                showAngleLabels: document.getElementById('showAngleLabels')
            };
            
            // 初始化函数 - 简化流程确保快速加载
            function init() {
                // 绘制刻度尺
                drawRulers();
                
                // 初始化量角器
                initProtractor();
                
                // 设置事件监听
                setupEventListeners();
            }
            
            // 绘制刻度尺 - 简化绘制逻辑
            function drawRulers() {
                // 绘制顶部水平刻度尺
                if (elements.showTopRuler.checked) {
                    elements.topRuler.style.display = 'block';
                    drawHorizontalRuler();
                } else {
                    elements.topRuler.style.display = 'none';
                }
                
                // 绘制左侧垂直刻度尺
                if (elements.showLeftRuler.checked) {
                    elements.leftRuler.style.display = 'block';
                    drawVerticalRuler();
                } else {
                    elements.leftRuler.style.display = 'none';
                }
            }
            
            // 绘制水平刻度尺
            function drawHorizontalRuler() {
                // 清空现有内容
                elements.topRulerMarks.innerHTML = '';
                
                const width = elements.measurementArea.offsetWidth - 30; // 减去左侧刻度尺宽度
                const precision = parseInt(elements.rulerPrecision.value) || 1;
                
                // 每毫米绘制一个刻度（根据精度调整）
                for (let mm = 0; mm <= width * PX_PER_MM; mm += precision) {
                    const px = mm / PX_PER_MM;
                    
                    // 创建刻度线
                    const mark = document.createElement('div');
                    mark.className = 'ruler-mark';
                    
                    // 根据毫米数设置不同长度的刻度
                    if (mm % 10 === 0) {
                        // 1厘米主刻度
                        mark.style.height = '8px';
                        mark.style.width = '1px';
                        
                        // 添加厘米标签
                        const label = document.createElement('div');
                        label.className = 'ruler-label';
                        label.textContent = (mm / 10).toFixed(1);
                        label.style.left = `${px}px`;
                        label.style.top = '2px';
                        label.style.transform = 'translateX(-50%)';
                        elements.topRulerMarks.appendChild(label);
                    } else if (mm % 5 === 0) {
                        // 5毫米刻度
                        mark.style.height = '5px';
                        mark.style.width = '1px';
                    } else {
                        // 1毫米刻度
                        mark.style.height = '3px';
                        mark.style.width = '1px';
                    }
                    
                    mark.style.left = `${px}px`;
                    mark.style.bottom = '0';
                    elements.topRulerMarks.appendChild(mark);
                }
            }
            
            // 绘制垂直刻度尺
            function drawVerticalRuler() {
                // 清空现有内容
                elements.leftRulerMarks.innerHTML = '';
                
                const height = elements.measurementArea.offsetHeight - 30; // 减去顶部刻度尺高度
                const precision = parseInt(elements.rulerPrecision.value) || 1;
                
                // 每毫米绘制一个刻度（根据精度调整）
                for (let mm = 0; mm <= height * PX_PER_MM; mm += precision) {
                    const px = mm / PX_PER_MM;
                    
                    // 创建刻度线
                    const mark = document.createElement('div');
                    mark.className = 'ruler-mark';
                    
                    // 根据毫米数设置不同长度的刻度
                    if (mm % 10 === 0) {
                        // 1厘米主刻度
                        mark.style.width = '8px';
                        mark.style.height = '1px';
                        
                        // 添加厘米标签
                        const label = document.createElement('div');
                        label.className = 'ruler-label';
                        label.textContent = (mm / 10).toFixed(1);
                        label.style.top = `${px}px`;
                        label.style.right = '2px';
                        label.style.transform = 'translateY(-50%)';
                        elements.leftRulerMarks.appendChild(label);
                    } else if (mm % 5 === 0) {
                        // 5毫米刻度
                        mark.style.width = '5px';
                        mark.style.height = '1px';
                    } else {
                        // 1毫米刻度
                        mark.style.width = '3px';
                        mark.style.height = '1px';
                    }
                    
                    mark.style.top = `${px}px`;
                    mark.style.right = '0';
                    elements.leftRulerMarks.appendChild(mark);
                }
            }
            
            // 初始化量角器
            function initProtractor() {
                const center = getCenterPoint();
                
                // 设置中心点
                elements.centerDot.style.left = `${center.x}px`;
                elements.centerDot.style.top = `${center.y}px`;
                
                // 绘制量角器
                drawProtractor();
            }
            
            // 绘制量角器
            function drawProtractor() {
                // 清空现有内容
                elements.angleLines.innerHTML = '';
                
                const center = getCenterPoint();
                const sizePercent = parseInt(elements.protractorSize.value) / 100;
                
                // 计算最大半径
                const maxRadius = Math.min(
                    center.x - 10,
                    elements.measurementArea.offsetWidth - center.x - 10,
                    center.y - 10,
                    elements.measurementArea.offsetHeight - center.y - 10
                ) * sizePercent;
                
                // 设置量角器圆
                elements.protractorCircle.style.width = `${maxRadius * 2}px`;
                elements.protractorCircle.style.height = `${maxRadius * 2}px`;
                elements.protractorCircle.style.left = `${center.x - maxRadius}px`;
                elements.protractorCircle.style.top = `${center.y - maxRadius}px`;
                
                // 绘制角度线（每10度一条主刻度，每5度一条中刻度）
                for (let angle = 0; angle < 360; angle += 5) {
                    // 创建角度线
                    const line = document.createElement('div');
                    line.className = 'angle-line';
                    
                    // 设置线长度
                    const lineLength = angle % 10 === 0 ? maxRadius * 0.15 : maxRadius * 0.08;
                    
                    line.style.width = `${lineLength}px`;
                    line.style.left = `${center.x}px`;
                    line.style.top = `${center.y}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    line.style.marginLeft = `-${lineLength}px`;
                    
                    elements.angleLines.appendChild(line);
                    
                    // 添加角度标签（每10度）
                    if (elements.showAngleLabels.checked && angle % 10 === 0) {
                        const label = document.createElement('div');
                        label.className = 'angle-label';
                        label.textContent = `${angle}°`;
                        
                        const rad = angle * Math.PI / 180;
                        const labelRadius = maxRadius * 1.05;
                        const x = center.x + labelRadius * Math.cos(rad);
                        const y = center.y + labelRadius * Math.sin(rad);
                        
                        label.style.left = `${x}px`;
                        label.style.top = `${y}px`;
                        
                        elements.angleLines.appendChild(label);
                    }
                }
            }
            
            // 获取测量区域中心点
            function getCenterPoint() {
                return {
                    x: elements.measurementArea.offsetWidth / 2,
                    y: elements.measurementArea.offsetHeight / 2
                };
            }
            
            // 添加测量点
            function addMeasurementPoint(x, y) {
                // 限制最多两个点
                if (measurementPoints.length >= 2) {
                    clearMeasurements();
                }
                
                // 添加点
                measurementPoints.push({x, y});
                
                // 创建视觉点
                const point = document.createElement('div');
                point.className = 'measure-point';
                point.style.left = `${x}px`;
                point.style.top = `${y}px`;
                elements.measureElements.appendChild(point);
                
                // 计算测量结果
                if (measurementPoints.length === 2) {
                    calculateMeasurement();
                }
            }
            
            // 计算测量结果
            function calculateMeasurement() {
                const p1 = measurementPoints[0];
                const p2 = measurementPoints[1];
                
                if (currentMode === 'ruler') {
                    // 计算距离
                    calculateDistance(p1, p2);
                } else {
                    // 计算角度
                    calculateAngle(p1, p2);
                }
            }
            
            // 计算两点之间的距离
            function calculateDistance(p1, p2) {
                // 计算像素距离
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const pxDistance = Math.sqrt(dx * dx + dy * dy);
                
                // 转换为厘米
                const cmDistance = (pxDistance * PX_PER_MM) / 10;
                
                // 显示结果
                elements.measurementResult.textContent = `${cmDistance.toFixed(1)} 厘米`;
                
                // 绘制连接线
                const line = document.createElement('div');
                line.className = 'measure-line';
                
                // 计算角度
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.width = `${pxDistance}px`;
                line.style.left = `${p1.x}px`;
                line.style.top = `${p1.y}px`;
                line.style.transform = `rotate(${angle}deg)`;
                
                elements.measureElements.appendChild(line);
                
                // 添加标签
                const label = document.createElement('div');
                label.className = 'measure-label';
                label.textContent = `${cmDistance.toFixed(1)} 厘米`;
                label.style.left = `${(p1.x + p2.x) / 2}px`;
                label.style.top = `${(p1.y + p2.y) / 2 - 20}px`;
                label.style.transform = 'translateX(-50%)';
                
                elements.measureElements.appendChild(label);
            }
            
            // 计算角度
            function calculateAngle(p1, p2) {
                const center = getCenterPoint();
                
                // 计算向量
                const v1x = p1.x - center.x;
                const v1y = p1.y - center.y;
                const v2x = p2.x - center.x;
                const v2y = p2.y - center.y;
                
                // 计算向量长度
                const len1 = Math.sqrt(v1x * v1x + v1y * v1y);
                const len2 = Math.sqrt(v2x * v2x + v2y * v2y);
                
                // 防止除以零
                if (len1 === 0 || len2 === 0) {
                    elements.measurementResult.textContent = '0.0°';
                    return;
                }
                
                // 计算点积
                const dotProduct = v1x * v2x + v1y * v2y;
                
                // 计算角度（弧度）
                const angleRad = Math.acos(Math.max(-1, Math.min(1, dotProduct / (len1 * len2))));
                
                // 转换为角度
                let angleDeg = angleRad * 180 / Math.PI;
                
                // 取最小角度
                angleDeg = Math.min(angleDeg, 360 - angleDeg);
                
                // 显示结果
                elements.measurementResult.textContent = `${angleDeg.toFixed(1)}°`;
                
                // 绘制两条线
                drawLineFromCenter(center, p1);
                drawLineFromCenter(center, p2);
                
                // 添加标签
                const label = document.createElement('div');
                label.className = 'measure-label';
                label.textContent = `${angleDeg.toFixed(1)}°`;
                
                // 计算标签位置
                const midX = (p1.x + p2.x) / 2;
                const midY = (p1.y + p2.y) / 2;
                label.style.left = `${midX}px`;
                label.style.top = `${midY}px`;
                label.style.transform = 'translate(-50%, -50%)';
                
                elements.measureElements.appendChild(label);
            }
            
            // 从中心点绘制线到指定点
            function drawLineFromCenter(center, point) {
                const line = document.createElement('div');
                line.className = 'measure-line';
                
                const dx = point.x - center.x;
                const dy = point.y - center.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.width = `${length}px`;
                line.style.left = `${center.x}px`;
                line.style.top = `${center.y}px`;
                line.style.transform = `rotate(${angle}deg)`;
                
                elements.measureElements.appendChild(line);
            }
            
            // 清除测量结果
            function clearMeasurements() {
                measurementPoints = [];
                elements.measureElements.innerHTML = '';
                elements.measurementResult.textContent = currentMode === 'ruler' ? '0 厘米' : '0°';
            }
            
            // 切换测量模式
            function switchMode(mode) {
                currentMode = mode;
                
                // 更新UI
                if (mode === 'ruler') {
                    elements.rulerMode.classList.add('active');
                    elements.protractorMode.classList.remove('active');
                    elements.protractor.style.display = 'none';
                    elements.modeHint.textContent = '刻度尺模式：点击测量区域添加两点，测量直线距离';
                    elements.measurementResult.textContent = '0 厘米';
                    
                    // 显示刻度尺
                    if (elements.showTopRuler.checked) elements.topRuler.style.display = 'block';
                    if (elements.showLeftRuler.checked) elements.leftRuler.style.display = 'block';
                } else {
                    elements.protractorMode.classList.add('active');
                    elements.rulerMode.classList.remove('active');
                    elements.protractor.style.display = 'block';
                    elements.modeHint.textContent = '量角器模式：点击添加两点，测量与中心点形成的角度';
                    elements.measurementResult.textContent = '0°';
                    
                    // 隐藏刻度尺
                    elements.topRuler.style.display = 'none';
                    elements.leftRuler.style.display = 'none';
                    
                    // 确保量角器正确绘制
                    drawProtractor();
                }
                
                // 清除现有测量
                clearMeasurements();
            }
            
            // 切换全屏
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        alert('无法进入全屏模式: ' + err.message);
                    });
                    elements.fullscreenBtn.innerHTML = '<i class="fa fa-compress"></i> 退出全屏';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        elements.fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i> 全屏';
                    }
                }
            }
            
            // 显示/隐藏设置面板
            function toggleSettings() {
                elements.settingsPanel.classList.toggle('open');
            }
            
            // 保存设置
            function saveSettings() {
                // 重绘刻度尺
                drawRulers();
                
                // 如果是量角器模式，重绘量角器
                if (currentMode === 'protractor') {
                    drawProtractor();
                }
                
                // 关闭设置面板
                toggleSettings();
            }
            
            // 设置事件监听 - 减少不必要的事件绑定
            function setupEventListeners() {
                // 测量区域点击
                elements.measurementArea.addEventListener('click', function(e) {
                    const rect = elements.measurementArea.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    addMeasurementPoint(x, y);
                });
                
                // 模式切换
                elements.rulerMode.addEventListener('click', () => switchMode('ruler'));
                elements.protractorMode.addEventListener('click', () => switchMode('protractor'));
                
                // 重置按钮
                elements.resetBtn.addEventListener('click', clearMeasurements);
                
                // 全屏按钮
                elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
                
                // 设置面板
                elements.settingsBtn.addEventListener('click', toggleSettings);
                elements.closeSettings.addEventListener('click', toggleSettings);
                elements.saveSettings.addEventListener('click', saveSettings);
                
                // 窗口大小变化时重绘
                window.addEventListener('resize', function() {
                    drawRulers();
                    if (currentMode === 'protractor') {
                        initProtractor();
                    }
                });
            }
            
            // 启动应用
            init();
        });
    </script>
</body>
</html>