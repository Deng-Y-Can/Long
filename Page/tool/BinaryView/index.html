<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高效文件二进制查看器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        dark: '#1D2129',
                        light: '#F2F3F5',
                        neutral: '#86909C',
                    },
                    fontFamily: {
                        mono: ['Consolas', 'Monaco', 'Courier New', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .view-row {
                @apply flex items-center border-b border-gray-100 py-1;
            }
            .view-row:hover {
                @apply bg-gray-50;
            }
            .hex-byte {
                @apply inline-block w-8 text-center font-mono text-sm md:text-base;
            }
            .ascii-char {
                @apply inline-block w-6 text-center font-mono text-sm md:text-base;
            }
            .offset {
                @apply inline-block w-16 text-right pr-4 font-mono text-sm md:text-base text-neutral;
            }
            .highlight {
                @apply bg-primary/20 rounded;
            }
            .search-highlight {
                @apply bg-yellow-200 rounded;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-code text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">高效文件二进制查看器</h1>
            </div>
            
            <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-moon-o text-neutral" id="theme-icon"></i>
                </button>
                
                <button id="about-btn" class="flex items-center space-x-1 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-info-circle"></i>
                    <span class="hidden sm:inline">关于</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-1 container mx-auto px-4 py-6">
        <!-- 文件上传区域 -->
        <section class="mb-8">
            <div id="upload-container" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center transition-all duration-300 hover:border-primary/50 hover:bg-primary/5">
                <i class="fa fa-cloud-upload text-5xl text-primary/70 mb-4"></i>
                <h2 class="text-xl font-semibold mb-2">上传文件以查看二进制内容</h2>
                <p class="text-neutral mb-6">支持所有文件类型，采用高效渲染技术处理大文件</p>
                
                <label class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 cursor-pointer shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fa fa-file-o mr-2"></i>选择文件
                    <input type="file" id="file-input" class="hidden" accept="*/*" />
                </label>
                
                <div id="file-info" class="mt-6 hidden">
                    <div class="flex flex-wrap items-center justify-center p-4 bg-gray-50 rounded-lg border border-gray-100">
                        <i class="fa fa-file-text-o text-primary mr-3 text-xl"></i>
                        <div class="flex-1 min-w-0">
                            <p id="file-name" class="font-medium truncate"></p>
                            <p id="file-size" class="text-sm text-neutral">文件大小: <span id="size-value"></span></p>
                        </div>
                        <button id="cancel-upload" class="ml-4 text-neutral hover:text-danger transition-colors">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 加载指示器 -->
            <div id="loading-indicator" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <p class="mt-2 text-neutral">正在加载文件内容...</p>
                <p id="load-progress" class="text-sm text-neutral mt-1">0%</p>
            </div>
        </section>
        
        <!-- 查看器控制区 -->
        <section id="viewer-controls" class="mb-6 hidden bg-white rounded-lg shadow-sm p-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-neutral whitespace-nowrap">字节/行:</span>
                    <select id="bytes-per-line" class="bg-white border border-gray-300 text-dark text-sm rounded-lg focus:ring-primary focus:border-primary p-2">
                        <option value="8">8</option>
                        <option value="16" selected>16</option>
                        <option value="32">32</option>
                        <option value="64">64</option>
                    </select>
                    
                    <div class="mx-2 h-4 border-r border-gray-200"></div>
                    
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button type="button" id="highlight-hover" class="px-3 py-1.5 text-sm font-medium bg-primary text-white rounded-l-lg border border-primary hover:bg-primary/90 transition-colors">
                            <i class="fa fa-mouse-pointer mr-1"></i>悬停高亮
                        </button>
                        <button type="button" id="highlight-off" class="px-3 py-1.5 text-sm font-medium bg-white text-dark border border-gray-200 rounded-r-lg hover:bg-gray-100 transition-colors">
                            <i class="fa fa-ban mr-1"></i>关闭
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center">
                        <span class="text-neutral mr-2">搜索:</span>
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="输入十六进制或文本..." 
                                class="bg-white border border-gray-300 text-dark text-sm rounded-lg focus:ring-primary focus:border-primary p-2 pl-8 w-48 md:w-64">
                            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral"></i>
                        </div>
                        <button id="search-next" class="ml-1 p-2 text-neutral hover:text-primary transition-colors">
                            <i class="fa fa-chevron-down"></i>
                        </button>
                        <button id="search-prev" class="p-2 text-neutral hover:text-primary transition-colors">
                            <i class="fa fa-chevron-up"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap items-center justify-between gap-4">
                <div class="text-sm text-neutral">
                    显示: <span id="display-range">0-0</span> / <span id="total-bytes">0</span> 字节
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="zoom-out" class="p-2 rounded hover:bg-gray-100 transition-colors">
                        <i class="fa fa-search-minus text-neutral"></i>
                    </button>
                    <button id="zoom-reset" class="p-2 rounded hover:bg-gray-100 transition-colors">
                        <i class="fa fa-home text-neutral"></i>
                    </button>
                    <button id="zoom-in" class="p-2 rounded hover:bg-gray-100 transition-colors">
                        <i class="fa fa-search-plus text-neutral"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- 二进制查看器区域 -->
        <section id="binary-viewer" class="hidden bg-white rounded-lg shadow-sm overflow-hidden">
            <!-- 表头 -->
            <div class="bg-gray-50 border-b border-gray-200 sticky top-16 z-20">
                <div class="flex">
                    <div class="w-16 p-2 font-mono text-sm font-medium text-neutral">偏移</div>
                    <div id="hex-header" class="flex-1 p-2 font-mono text-sm font-medium text-neutral">
                        十六进制
                    </div>
                    <div class="w-[calc(16*1.5rem)] p-2 font-mono text-sm font-medium text-neutral">
                        ASCII
                    </div>
                </div>
            </div>
            
            <!-- 内容容器 -->
            <div id="viewer-content" class="overflow-auto scrollbar-thin" style="height: 60vh;">
                <div id="render-container" class="font-mono"></div>
                
                <!-- 加载提示 -->
                <div id="loading-more" class="hidden py-4 text-center">
                    <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                    <span class="ml-2 text-sm text-neutral">加载更多内容...</span>
                </div>
            </div>
        </section>
        
        <!-- 空状态 -->
        <section id="empty-state" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="bg-gray-100 p-6 rounded-full mb-6">
                <i class="fa fa-file-code-o text-5xl text-neutral/50"></i>
            </div>
            <h2 class="text-xl font-semibold mb-2">尚未加载任何文件</h2>
            <p class="text-neutral max-w-md">上传一个文件来查看其二进制内容，支持大文件高效渲染</p>
        </section>
        
        <!-- 错误状态 -->
        <section id="error-state" class="hidden flex flex-col items-center justify-center py-16 text-center">
            <div class="bg-danger/10 p-6 rounded-full mb-6">
                <i class="fa fa-exclamation-triangle text-5xl text-danger"></i>
            </div>
            <h2 class="text-xl font-semibold mb-2 text-danger">加载文件时出错</h2>
            <p id="error-message" class="text-neutral max-w-md mb-6">发生未知错误，请尝试再次上传文件。</p>
            <button id="retry-button" class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition-all duration-300 cursor-pointer">
                重试
            </button>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-6">
        <div class="container mx-auto px-4 text-center text-neutral text-sm">
            <p>高效文件二进制查看器 | 本地处理，保护隐私 | 支持大文件浏览</p>
        </div>
    </footer>

    <!-- 关于模态框 -->
    <div id="about-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-primary">关于二进制查看器</h3>
                    <button id="close-modal" class="text-neutral hover:text-dark transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p class="mb-4">这是一个高效的文件二进制查看器，采用分批渲染技术，可以处理大型文件而不会导致浏览器卡顿。</p>
                <p class="mb-4">主要特点：</p>
                <ul class="list-disc pl-5 mb-4 space-y-1">
                    <li>一行显示多个字节（可配置8/16/32/64字节）</li>
                    <li>分三列显示：偏移地址、十六进制值、ASCII字符</li>
                    <li>高效渲染，只加载可视区域内容</li>
                    <li>支持文件搜索（文本和十六进制）</li>
                    <li>所有处理都在本地进行，保护隐私</li>
                </ul>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl text-center">
                <button id="got-it-btn" class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition-all duration-300">
                    了解了
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局配置和状态
        const config = {
            batchSize: 1000,       // 每次渲染的行数
            preloadDistance: 500,  // 预加载距离(px)
            maxRenderedLines: 3000 // 最大渲染行数，防止内存溢出
        };

        // 应用状态
        const state = {
            fileData: null,        // 文件的二进制数据
            fileName: '',          // 文件名
            fileSize: 0,           // 文件大小(字节)
            bytesPerLine: 16,      // 每行显示的字节数
            totalLines: 0,         // 总行数
            startLine: 0,          // 当前渲染的起始行
            endLine: 0,            // 当前渲染的结束行
            renderedLines: new Set(), // 已渲染的行
            zoomLevel: 1,          // 缩放级别
            highlightMode: 'hover',// 高亮模式
            searchResults: [],     // 搜索结果
            currentSearchIndex: -1,// 当前搜索索引
            isLoading: false,      // 是否正在加载
            isDarkMode: false      // 是否深色模式
        };

        // DOM元素
        const elements = {
            fileInput: document.getElementById('file-input'),
            fileInfo: document.getElementById('file-info'),
            fileName: document.getElementById('file-name'),
            sizeValue: document.getElementById('size-value'),
            totalBytes: document.getElementById('total-bytes'),
            displayRange: document.getElementById('display-range'),
            cancelUpload: document.getElementById('cancel-upload'),
            uploadContainer: document.getElementById('upload-container'),
            loadingIndicator: document.getElementById('loading-indicator'),
            loadProgress: document.getElementById('load-progress'),
            viewerControls: document.getElementById('viewer-controls'),
            binaryViewer: document.getElementById('binary-viewer'),
            viewerContent: document.getElementById('viewer-content'),
            renderContainer: document.getElementById('render-container'),
            loadingMore: document.getElementById('loading-more'),
            emptyState: document.getElementById('empty-state'),
            errorState: document.getElementById('error-state'),
            errorMessage: document.getElementById('error-message'),
            retryButton: document.getElementById('retry-button'),
            bytesPerLine: document.getElementById('bytes-per-line'),
            highlightHover: document.getElementById('highlight-hover'),
            highlightOff: document.getElementById('highlight-off'),
            searchInput: document.getElementById('search-input'),
            searchNext: document.getElementById('search-next'),
            searchPrev: document.getElementById('search-prev'),
            zoomIn: document.getElementById('zoom-in'),
            zoomOut: document.getElementById('zoom-out'),
            zoomReset: document.getElementById('zoom-reset'),
            aboutBtn: document.getElementById('about-btn'),
            aboutModal: document.getElementById('about-modal'),
            modalContent: document.getElementById('modal-content'),
            closeModalBtn: document.getElementById('close-modal'),
            gotItBtn: document.getElementById('got-it-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIcon: document.getElementById('theme-icon')
        };

        // 初始化事件监听
        function initEventListeners() {
            // 文件上传相关
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.cancelUpload.addEventListener('click', resetFileSelection);
            elements.retryButton.addEventListener('click', resetFileSelection);
            
            // 查看器控制
            elements.bytesPerLine.addEventListener('change', handleBytesPerLineChange);
            elements.highlightHover.addEventListener('click', () => setHighlightMode('hover'));
            elements.highlightOff.addEventListener('click', () => setHighlightMode('off'));
            
            // 缩放控制
            elements.zoomIn.addEventListener('click', zoomIn);
            elements.zoomOut.addEventListener('click', zoomOut);
            elements.zoomReset.addEventListener('click', resetZoom);
            
            // 搜索控制
            elements.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });
            elements.searchNext.addEventListener('click', () => navigateSearch(1));
            elements.searchPrev.addEventListener('click', () => navigateSearch(-1));
            
            // 滚动加载
            elements.viewerContent.addEventListener('scroll', handleScroll);
            
            // 关于模态框
            elements.aboutBtn.addEventListener('click', openAboutModal);
            elements.closeModalBtn.addEventListener('click', closeAboutModal);
            elements.gotItBtn.addEventListener('click', closeAboutModal);
            elements.aboutModal.addEventListener('click', (e) => {
                if (e.target === elements.aboutModal) closeAboutModal();
            });
            
            // 主题切换
            elements.themeToggle.addEventListener('click', toggleTheme);
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 显示文件信息
            state.fileName = file.name;
            state.fileSize = file.size;
            elements.fileName.textContent = state.fileName;
            elements.sizeValue.textContent = formatFileSize(state.fileSize);
            elements.fileInfo.classList.remove('hidden');
            elements.uploadContainer.classList.add('opacity-50');
            
            // 读取文件
            const reader = new FileReader();
            const fileSize = file.size;
            
            // 显示加载指示器
            elements.loadingIndicator.classList.remove('hidden');
            elements.emptyState.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.viewerControls.classList.add('hidden');
            elements.binaryViewer.classList.add('hidden');
            
            // 进度更新
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    elements.loadProgress.textContent = `${percent}%`;
                }
            };
            
            // 加载完成
            reader.onload = (e) => {
                try {
                    // 存储文件数据
                    state.fileData = new Uint8Array(e.target.result);
                    state.totalBytes = state.fileData.length;
                    
                    // 计算总行数
                    updateTotalLines();
                    
                    // 重置渲染状态
                    resetRenderState();
                    
                    // 更新UI
                    elements.loadingIndicator.classList.add('hidden');
                    elements.viewerControls.classList.remove('hidden');
                    elements.binaryViewer.classList.remove('hidden');
                    elements.totalBytes.textContent = state.totalBytes;
                    updateDisplayRange();
                    
                    // 初始渲染
                    renderVisibleLines();
                } catch (error) {
                    showError(`处理文件时出错: ${error.message}`);
                }
            };
            
            // 错误处理
            reader.onerror = () => {
                showError(`无法读取文件: ${reader.error.message}`);
            };
            
            // 以二进制方式读取文件
            reader.readAsArrayBuffer(file);
        }

        // 重置文件选择
        function resetFileSelection() {
            elements.fileInput.value = '';
            elements.fileInfo.classList.add('hidden');
            elements.uploadContainer.classList.remove('opacity-50');
            
            // 重置状态
            state.fileData = null;
            state.fileName = '';
            state.fileSize = 0;
            state.searchResults = [];
            state.currentSearchIndex = -1;
            
            // 重置UI
            elements.loadingIndicator.classList.add('hidden');
            elements.viewerControls.classList.add('hidden');
            elements.binaryViewer.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyState.classList.remove('hidden');
            elements.searchInput.value = '';
        }

        // 显示错误信息
        function showError(message) {
            elements.loadingIndicator.classList.add('hidden');
            elements.errorMessage.textContent = message;
            elements.errorState.classList.remove('hidden');
        }

        // 更新总行数
        function updateTotalLines() {
            if (!state.fileData) return;
            state.totalLines = Math.ceil(state.fileData.length / state.bytesPerLine);
        }

        // 重置渲染状态
        function resetRenderState() {
            state.startLine = 0;
            state.endLine = 0;
            state.renderedLines.clear();
            elements.renderContainer.innerHTML = '';
        }

        // 处理每行字节数变化
        function handleBytesPerLineChange(e) {
            const newBytesPerLine = parseInt(e.target.value);
            if (newBytesPerLine === state.bytesPerLine) return;
            
            state.bytesPerLine = newBytesPerLine;
            updateTotalLines();
            resetRenderState();
            renderVisibleLines();
            updateDisplayRange();
        }

        // 设置高亮模式
        function setHighlightMode(mode) {
            state.highlightMode = mode;
            
            // 更新按钮样式
            if (mode === 'hover') {
                elements.highlightHover.className = 'px-3 py-1.5 text-sm font-medium bg-primary text-white rounded-l-lg border border-primary hover:bg-primary/90 transition-colors';
                elements.highlightOff.className = 'px-3 py-1.5 text-sm font-medium bg-white text-dark border border-gray-200 rounded-r-lg hover:bg-gray-100 transition-colors';
            } else {
                elements.highlightHover.className = 'px-3 py-1.5 text-sm font-medium bg-white text-dark border border-gray-200 rounded-l-lg hover:bg-gray-100 transition-colors';
                elements.highlightOff.className = 'px-3 py-1.5 text-sm font-medium bg-primary text-white rounded-r-lg border border-primary hover:bg-primary/90 transition-colors';
                
                // 移除所有高亮
                document.querySelectorAll('.highlight').forEach(el => {
                    el.classList.remove('highlight');
                });
            }
        }

        // 处理滚动事件
        function handleScroll() {
            if (!state.fileData || state.isLoading) return;
            
            const container = elements.viewerContent;
            const scrollTop = container.scrollTop;
            const clientHeight = container.clientHeight;
            const scrollHeight = container.scrollHeight;
            
            // 计算需要渲染的区域
            const lineHeight = 20; // 估算行高
            const visibleStartLine = Math.max(0, Math.floor(scrollTop / lineHeight) - 10);
            const visibleEndLine = Math.min(state.totalLines, Math.ceil((scrollTop + clientHeight) / lineHeight) + 10);
            
            // 检查是否需要加载更多
            if (scrollTop + clientHeight + config.preloadDistance >= scrollHeight && 
                state.endLine < state.totalLines) {
                renderMoreLines();
            }
            
            // 更新显示范围
            updateDisplayRange();
        }

        // 渲染可见行
        function renderVisibleLines() {
            if (!state.fileData) return;
            
            const container = elements.viewerContent;
            const lineHeight = 20; // 估算行高
            const scrollTop = container.scrollTop;
            const clientHeight = container.clientHeight;
            
            // 计算可见范围，增加一些缓冲
            const visibleStartLine = Math.max(0, Math.floor(scrollTop / lineHeight) - 20);
            const visibleEndLine = Math.min(state.totalLines, 
                Math.ceil((scrollTop + clientHeight) / lineHeight) + 20);
            
            // 确保不超过最大渲染行数
            const maxLinesToRender = Math.min(config.batchSize, config.maxRenderedLines);
            const actualEndLine = Math.min(visibleEndLine, visibleStartLine + maxLinesToRender);
            
            // 渲染可见行
            renderLines(visibleStartLine, actualEndLine);
            
            // 更新状态
            state.startLine = visibleStartLine;
            state.endLine = actualEndLine;
        }

        // 渲染更多行
        function renderMoreLines() {
            if (!state.fileData || state.isLoading || state.endLine >= state.totalLines) return;
            
            state.isLoading = true;
            elements.loadingMore.classList.remove('hidden');
            
            // 使用requestIdleCallback或setTimeout避免阻塞UI
            setTimeout(() => {
                const newStartLine = state.endLine;
                const newEndLine = Math.min(state.endLine + config.batchSize, state.totalLines);
                
                renderLines(newStartLine, newEndLine);
                
                // 更新状态
                state.endLine = newEndLine;
                state.isLoading = false;
                elements.loadingMore.classList.add('hidden');
            }, 50);
        }

        // 渲染指定范围的行
        function renderLines(startLine, endLine) {
            if (!state.fileData || startLine >= endLine) return;
            
            const fragment = document.createDocumentFragment();
            let newLinesRendered = 0;
            
            for (let line = startLine; line < endLine; line++) {
                // 跳过已渲染的行
                if (state.renderedLines.has(line)) continue;
                
                // 创建行元素
                const rowElement = createRowElement(line);
                fragment.appendChild(rowElement);
                
                // 标记为已渲染
                state.renderedLines.add(line);
                newLinesRendered++;
                
                // 每渲染100行就释放一次UI线程
                if (newLinesRendered % 100 === 0) {
                    elements.renderContainer.appendChild(fragment);
                    fragment.textContent = ''; // 清空片段
                    
                    // 强制重绘
                    void elements.renderContainer.offsetWidth;
                }
            }
            
            // 添加剩余内容
            if (fragment.children.length > 0) {
                elements.renderContainer.appendChild(fragment);
            }
            
            // 清理超出范围的行，防止内存占用过大
            cleanupOldLines(startLine - config.batchSize);
        }

        // 创建行元素
        function createRowElement(lineNumber) {
            const startOffset = lineNumber * state.bytesPerLine;
            const endOffset = Math.min(startOffset + state.bytesPerLine, state.fileData.length);
            
            // 创建行容器
            const row = document.createElement('div');
            row.className = 'view-row';
            row.dataset.line = lineNumber;
            row.dataset.offset = startOffset;
            
            // 偏移地址
            const offsetHex = startOffset.toString(16).padStart(8, '0').toUpperCase();
            const offsetElement = document.createElement('div');
            offsetElement.className = 'offset';
            offsetElement.textContent = offsetHex;
            row.appendChild(offsetElement);
            
            // 十六进制部分
            const hexContainer = document.createElement('div');
            hexContainer.className = 'flex-1';
            
            // ASCII部分
            const asciiContainer = document.createElement('div');
            asciiContainer.className = '';
            
            // 填充字节数据
            for (let i = 0; i < state.bytesPerLine; i++) {
                const byteOffset = startOffset + i;
                
                // 超出文件范围则跳出
                if (byteOffset >= state.fileData.length) break;
                
                const byte = state.fileData[byteOffset];
                
                // 创建十六进制元素
                const hexElement = document.createElement('div');
                hexElement.className = 'hex-byte';
                hexElement.textContent = byte.toString(16).padStart(2, '0').toUpperCase();
                hexElement.dataset.offset = byteOffset;
                
                // 添加悬停高亮
                if (state.highlightMode === 'hover') {
                    hexElement.addEventListener('mouseenter', () => highlightByte(byteOffset));
                    hexElement.addEventListener('mouseleave', removeHighlights);
                }
                
                hexContainer.appendChild(hexElement);
                
                // 创建ASCII元素
                const asciiElement = document.createElement('div');
                asciiElement.className = 'ascii-char';
                
                // 非打印字符显示为点
                const isPrintable = byte >= 32 && byte <= 126;
                asciiElement.textContent = isPrintable ? String.fromCharCode(byte) : '.';
                asciiElement.dataset.offset = byteOffset;
                
                // 添加悬停高亮
                if (state.highlightMode === 'hover') {
                    asciiElement.addEventListener('mouseenter', () => highlightByte(byteOffset));
                    asciiElement.addEventListener('mouseleave', removeHighlights);
                }
                
                asciiContainer.appendChild(asciiElement);
            }
            
            row.appendChild(hexContainer);
            row.appendChild(asciiContainer);
            
            return row;
        }

        // 清理旧行
        function cleanupOldLines(thresholdLine) {
            if (state.renderedLines.size <= config.maxRenderedLines) return;
            
            const rows = elements.renderContainer.querySelectorAll('.view-row');
            for (const row of rows) {
                const line = parseInt(row.dataset.line);
                if (line < thresholdLine) {
                    elements.renderContainer.removeChild(row);
                    state.renderedLines.delete(line);
                }
            }
        }

        // 高亮字节
        function highlightByte(offset) {
            removeHighlights();
            
            const elements = document.querySelectorAll(`[data-offset="${offset}"]`);
            elements.forEach(el => {
                el.classList.add('highlight');
            });
        }

        // 移除所有高亮
        function removeHighlights() {
            document.querySelectorAll('.highlight').forEach(el => {
                el.classList.remove('highlight');
            });
        }

        // 执行搜索
        function performSearch() {
            const searchTerm = elements.searchInput.value.trim();
            if (!searchTerm || !state.fileData) {
                clearSearchHighlights();
                state.searchResults = [];
                state.currentSearchIndex = -1;
                return;
            }
            
            // 查找匹配项
            state.searchResults = findMatches(searchTerm);
            state.currentSearchIndex = state.searchResults.length > 0 ? 0 : -1;
            
            // 高亮搜索结果
            highlightSearchResults();
            
            // 滚动到第一个结果
            if (state.currentSearchIndex !== -1) {
                scrollToSearchResult(state.currentSearchIndex);
            }
        }

        // 查找匹配项
        function findMatches(searchTerm) {
            // 尝试解析为十六进制
            if (/^[0-9A-Fa-f\s]+$/.test(searchTerm)) {
                const hexStr = searchTerm.replace(/\s+/g, '');
                if (hexStr.length % 2 === 0) {
                    const bytes = [];
                    for (let i = 0; i < hexStr.length; i += 2) {
                        const byte = parseInt(hexStr.substr(i, 2), 16);
                        if (isNaN(byte)) return findTextMatches(searchTerm);
                        bytes.push(byte);
                    }
                    return findByteSequenceMatches(bytes);
                }
            }
            
            // 作为文本搜索
            return findTextMatches(searchTerm);
        }

        // 查找文本匹配项
        function findTextMatches(text) {
            const encoder = new TextEncoder();
            const searchBytes = encoder.encode(text);
            return findByteSequenceMatches(searchBytes);
        }

        // 查找字节序列匹配项
        function findByteSequenceMatches(sequence) {
            if (!state.fileData || sequence.length === 0) return [];
            
            const matches = [];
            const sequenceLength = sequence.length;
            
            // 高效搜索算法
            for (let i = 0; i <= state.fileData.length - sequenceLength; i++) {
                let match = true;
                
                // 检查序列匹配
                for (let j = 0; j < sequenceLength; j++) {
                    if (state.fileData[i + j] !== sequence[j]) {
                        match = false;
                        break;
                    }
                }
                
                // 如果匹配，添加所有相关偏移
                if (match) {
                    for (let j = 0; j < sequenceLength; j++) {
                        matches.push(i + j);
                    }
                }
            }
            
            return matches;
        }

        // 高亮搜索结果
        function highlightSearchResults() {
            clearSearchHighlights();
            
            if (!state.searchResults.length || state.currentSearchIndex === -1) return;
            
            // 高亮当前搜索结果
            state.searchResults.forEach((offset, index) => {
                const elements = document.querySelectorAll(`[data-offset="${offset}"]`);
                elements.forEach(el => {
                    el.classList.add(index === state.currentSearchIndex ? 'search-highlight' : 'search-highlight/50');
                });
            });
        }

        // 清除搜索高亮
        function clearSearchHighlights() {
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.classList.remove('search-highlight', 'search-highlight/50');
            });
        }

        // 导航搜索结果
        function navigateSearch(direction) {
            if (!state.searchResults.length) {
                performSearch();
                return;
            }
            
            // 更新索引
            state.currentSearchIndex = (state.currentSearchIndex + direction + state.searchResults.length) % state.searchResults.length;
            
            // 高亮并滚动
            highlightSearchResults();
            scrollToSearchResult(state.currentSearchIndex);
        }

        // 滚动到搜索结果
        function scrollToSearchResult(index) {
            if (index < 0 || index >= state.searchResults.length) return;
            
            const offset = state.searchResults[index];
            const lineNumber = Math.floor(offset / state.bytesPerLine);
            
            // 确保行已渲染
            if (!state.renderedLines.has(lineNumber)) {
                // 先渲染该行附近的内容
                renderLines(Math.max(0, lineNumber - 10), Math.min(state.totalLines, lineNumber + 10));
            }
            
            // 滚动到行
            const row = document.querySelector(`[data-line="${lineNumber}"]`);
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 高亮具体字节
                setTimeout(() => {
                    highlightByte(offset);
                }, 300);
            }
        }

        // 缩放功能
        function zoomIn() {
            if (state.zoomLevel < 2) {
                state.zoomLevel += 0.1;
                applyZoom();
            }
        }

        function zoomOut() {
            if (state.zoomLevel > 0.5) {
                state.zoomLevel -= 0.1;
                applyZoom();
            }
        }

        function resetZoom() {
            state.zoomLevel = 1;
            applyZoom();
        }

        function applyZoom() {
            elements.renderContainer.style.transform = `scale(${state.zoomLevel})`;
            elements.renderContainer.style.transformOrigin = 'top left';
            elements.renderContainer.style.marginBottom = `${(state.zoomLevel - 1) * 100}px`;
        }

        // 更新显示范围
        function updateDisplayRange() {
            if (!state.fileData) return;
            
            const startByte = state.startLine * state.bytesPerLine;
            const endByte = Math.min(state.endLine * state.bytesPerLine, state.fileData.length);
            elements.displayRange.textContent = `${startByte}-${endByte}`;
        }

        // 打开关于模态框
        function openAboutModal() {
            elements.aboutModal.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                elements.modalContent.classList.remove('scale-95', 'opacity-0');
                elements.modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭关于模态框
        function closeAboutModal() {
            elements.modalContent.classList.remove('scale-100', 'opacity-100');
            elements.modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                elements.aboutModal.classList.add('hidden');
            }, 300);
        }

        // 切换主题
        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            
            if (state.isDarkMode) {
                document.body.classList.add('bg-dark', 'text-white');
                document.body.classList.remove('bg-gray-50', 'text-dark');
                elements.themeIcon.classList.remove('fa-moon-o');
                elements.themeIcon.classList.add('fa-sun-o');
            } else {
                document.body.classList.remove('bg-dark', 'text-white');
                document.body.classList.add('bg-gray-50', 'text-dark');
                elements.themeIcon.classList.remove('fa-sun-o');
                elements.themeIcon.classList.add('fa-moon-o');
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 初始化应用
        function init() {
            initEventListeners();
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>